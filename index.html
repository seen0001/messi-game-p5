<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Messi the GOAT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://molleindustria.github.io/p5.play/lib/p5.play.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Navigation Bar -->
    <nav id="mainNav">
        <ul>
            <li><a href="#" id="navHome">Home</a></li>
            <li><a href="#" id="navPlay">Play</a></li>
            <li><a href="about.html" id="navAbout">About</a></li>
        </ul>
    </nav>
    <div id="instructions" class="card" style="display:none; text-align:left; max-width: 440px;">
        <h2>How to Play</h2>
        <ul>
            <li>Move Messi left/right with the arrow keys.</li>
            <li>Catch the balls to score points.</li>
            <li>Don't let them fall past you!</li>
            <li>You have 3 lives. Good luck!</li>
        </ul>
        <button id="backToMenuFromInstructions" style="margin-top: 18px;" onclick="showMenu()">Back to Menu</button>
    </div>
    <button id="startBtn" onclick="startGame()" style="display:none;">Start</button>
    <button id="playAgainBtn" onclick="restartGame()"
        style="display:none; position: absolute; left: 50%; top: calc(50% + 120px); transform: translate(-50%, 0); z-index: 30;">Play
        Again</button>

    <div id="productionPage" class="card" style="display:none;">
        <!-- Removed: now in about.html -->
    </div>
    <div id="mainMenu" class="card" style="display:block; text-align:center;">
        <h1 style="color:#a50044; font-family:'Luckiest Guy', 'Fredoka One', cursive; font-size:3rem; margin-bottom:0;">
            Messi the GOAT</h1>
        <h2 style="color:#004d98; font-family:'Fredoka One', cursive; margin-top:0;">Main Menu</h2>
        <button id="menuPlayBtn" style="margin: 24px 0 12px 0;" onclick="menuPlay()">Play</button><br>
        <button id="menuInstructionsBtn" onclick="showInstructions()">Instructions</button>
    </div>

    <script>
        let player, bold;
        let playerImg, boldImg, backgroundImg;
        let score = 0, lives = 3;
        let gameOver = false;
        let gameState = "start"; // 'start', 'playing', 'gameover', 'paused', 'countdown'
        let pauseVelocities = [];
        let countdownValue = 3;
        let countdownTimer = 0;
        const NAV_HEIGHT = 70; // or whatever your nav bar height is

        function preload() {
            playerImg = loadImage("images/messi.png");
            boldImg = loadImage("images/fodbold.avif");
            backgroundImg = loadImage("images/fodboldbane.png");
        }

        function setup() {
            createCanvas(document.documentElement.clientWidth, document.documentElement.clientHeight);
        }

        function showStartUI() {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("instructions").style.display = "block";
            document.getElementById("startBtn").style.display = "block";
            document.getElementById("playAgainBtn").style.display = "none";
        }

        function hideStartUI() {
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("instructions").style.display = "none";
        }

        function startGame() {
            gameState = "playing";
            hideStartUI();
            setupGame();
        }

        function setupGame() {
            score = 0;
            lives = 3;
            gameOver = false;
            // Remove old player sprite if exists
            if (player) {
                player.remove();
                player = undefined;
            }
            // Remove all old bold sprites if exists
            if (bold) {
                for (let i = 0; i < bold.length; i++) {
                    bold[i].remove();
                }
                bold.removeSprites();
                bold = undefined;
            }
            document.getElementById("playAgainBtn").style.display = "none";

            player = createSprite(width / 2, height - 120, 120, 120);
            if (playerImg) player.addImage(playerImg);
            player.scale = 0.1;

            bold = new Group();
            for (let i = 0; i < 3; i++) {
                let m = createSprite(random(20, width - 20), random(-500, -50), 30, 30);
                if (boldImg) {
                    m.addImage(boldImg);
                    m.scale = 0.15;
                } else {
                    m.shapeColor = color(255, 215, 0);
                }
                m.velocity.y = random(3, 5);
                bold.add(m);
            }
        }

        function draw() {
            try {
                if (backgroundImg) {
                    background(backgroundImg);
                } else {
                    drawGradientBackground();
                }
            } catch (e) {
                console.warn("⚠️ Failed to draw SVG background, using gradient fallback");
                drawGradientBackground();
            }

            if (gameState === "start") {
                // Show start UI, nothing else
                return;
            }

            // Always show score, lives, and pause instruction except on start and gameover
            if (gameState !== "start" && gameState !== "gameover") {
                textFont('Luckiest Guy, Fredoka One, cursive');
                fill('#ffcb05'); // Barcelona yellow
                stroke('#004d98'); // Barcelona blue outline
                strokeWeight(4);
                textSize(32);
                textAlign(LEFT, TOP);
                // Shadow effect
                drawingContext.shadowColor = '#a50044';
                drawingContext.shadowBlur = 8;
                text("Score: " + score, 10, 20);
                text("Lives: " + lives, 10, 60);
                // Pause instruction
                textSize(18);
                strokeWeight(2);
                fill('#004d98');
                stroke('#ffcb05');
                drawingContext.shadowColor = '#fff';
                drawingContext.shadowBlur = 4;
                text("Press ESC to pause/resume", 12, 105);
                // Reset shadow for other text
                drawingContext.shadowBlur = 0;
                strokeWeight(1);
            }

            if (gameState === "playing" && !gameOver) {
                if (keyIsDown(LEFT_ARROW)) player.position.x -= 12;
                if (keyIsDown(RIGHT_ARROW)) player.position.x += 12;
                player.position.x = constrain(player.position.x, 30, width - 30);

                for (let i = 0; i < bold.length; i++) {
                    let m = bold[i];
                    if (m.position.y > height) {
                        m.position.y = random(-200, -50);
                        m.position.x = random(20, width - 20);
                        lives--;
                        if (lives <= 0) {
                            gameOver = true;
                            gameState = "gameover";
                            document.getElementById("playAgainBtn").style.display = "block";
                        }
                    }

                    if (player.overlap(m)) {
                        score++;
                        m.position.y = random(-200, -50);
                        m.position.x = random(20, width - 20);
                    }
                }

                drawSprites();
            } else if (gameState === "gameover") {
                // Cartoony Barcelona style for Game Over and Final Score
                textFont('Luckiest Guy, Fredoka One, cursive');
                fill('#ffcb05');
                stroke('#004d98');
                strokeWeight(6);
                textAlign(CENTER, CENTER);
                drawingContext.shadowColor = '#a50044';
                drawingContext.shadowBlur = 16;
                textSize(64);
                text("Game Over", width / 2, height / 2 - 60);
                textSize(36);
                text("Final Score: " + score, width / 2, height / 2 + 10);
                // Reset shadow for other text
                drawingContext.shadowBlur = 0;
                strokeWeight(1);
            } else if (gameState === "paused") {
                // Draw paused overlay
                textFont('Luckiest Guy, Fredoka One, cursive');
                fill('#ffcb05');
                stroke('#004d98');
                strokeWeight(8);
                textAlign(CENTER, CENTER);
                drawingContext.shadowColor = '#a50044';
                drawingContext.shadowBlur = 18;
                textSize(80);
                text("Paused", width / 2, height / 2 - 40);
                textSize(28);
                strokeWeight(3);
                fill('#004d98');
                stroke('#ffcb05');
                drawingContext.shadowColor = '#fff';
                drawingContext.shadowBlur = 4;
                text('Press "esc" to resume', width / 2, height / 2 + 40);
            } else if (gameState === "countdown") {
                // Countdown overlay
                let elapsed = Math.floor((millis() - countdownTimer) / 1000);
                let showValue = countdownValue - elapsed;
                if (showValue > 0) {
                    textFont('Luckiest Guy, Fredoka One, cursive');
                    fill('#ffcb05');
                    stroke('#004d98');
                    strokeWeight(8);
                    textAlign(CENTER, CENTER);
                    drawingContext.shadowColor = '#a50044';
                    drawingContext.shadowBlur = 18;
                    textSize(80);
                    text(showValue, width / 2, height / 2);
                } else {
                    // Restore velocities and resume
                    for (let i = 0; i < bold.length; i++) {
                        bold[i].velocity.y = pauseVelocities[i] || random(3, 5);
                    }
                    gameState = "playing";
                }
            }
        }

        function restartGame() {
            gameState = "playing";
            setupGame();
        }

        function windowResized() {
            resizeCanvas(document.documentElement.clientWidth, document.documentElement.clientHeight);
        }

        function keyPressed() {
            if ((keyCode === ENTER || key === 'Enter')) {
                if (gameState === "gameover") {
                    restartGame();
                } else if (gameState === "start") {
                    startGame();
                }
            }
            if (keyCode === ESCAPE || key === 'Escape') {
                if (gameState === "playing") {
                    // Store velocities and pause balls
                    pauseVelocities = [];
                    for (let i = 0; i < bold.length; i++) {
                        pauseVelocities[i] = bold[i].velocity.y;
                        bold[i].velocity.y = 0;
                    }
                    gameState = "paused";
                } else if (gameState === "paused") {
                    // Start countdown
                    countdownValue = 3;
                    countdownTimer = millis();
                    gameState = "countdown";
                }
            }
        }

        // MENU & ABOUT PAGE LOGIC
        function showMenu() {
            document.getElementById("mainMenu").style.display = "block";
            document.getElementById("instructions").style.display = "none";
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("playAgainBtn").style.display = "none";
        }
        function showAbout() {
            window.open('about.html', '_blank');
        }
        function menuPlay() {
            document.getElementById("mainMenu").style.display = "none";
            startGame();
        }
        function showInstructions() {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("instructions").style.display = "block";
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("playAgainBtn").style.display = "none";
        }
        // On load, show menu
        window.onload = function () {
            document.getElementById("mainMenu").style.display = "block";
            document.getElementById("instructions").style.display = "none";
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("playAgainBtn").style.display = "none";
        };
        // Nav bar event listeners
        document.getElementById('navHome').onclick = function (e) { e.preventDefault(); showMenu(); setActiveNav('navHome'); };
        document.getElementById('navPlay').onclick = function (e) { e.preventDefault(); menuPlay(); setActiveNav('navPlay'); };
        function setActiveNav(id) {
            document.getElementById('navHome').classList.remove('active');
            document.getElementById('navPlay').classList.remove('active');
            document.getElementById('navAbout').classList.remove('active');
            if (id) document.getElementById(id).classList.add('active');
        }
    </script>
</body>

</html>